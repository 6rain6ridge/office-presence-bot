const { Client, GatewayIntentBits, Partials, ActionRowBuilder, ButtonBuilder, ButtonStyle, EmbedBuilder } = require('discord.js');
const { Pool } = require('pg');
const express = require('express');

// Discord „ÇØ„É©„Ç§„Ç¢„É≥„ÉàË®≠ÂÆö
const client = new Client({
  intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages],
  partials: [Partials.Channel],
});

// Áí∞Â¢ÉÂ§âÊï∞
const TOKEN = process.env.DISCORD_TOKEN;
const DATABASE_URL = process.env.DATABASE_URL;
const PRESENCE_CHANNEL_ID = process.env.PRESENCE_CHANNEL_ID; // Âà©Áî®Áä∂Ê≥Å„Éë„Éç„É´„ÅÆ„ÉÅ„É£„É≥„Éç„É´
const LOG_CHANNEL_ID = process.env.LOG_CHANNEL_ID;           // Â±•Ê≠¥Áî®„ÉÅ„É£„É≥„Éç„É´

// Postgres Êé•Á∂ö„Éó„Éº„É´
const pool = new Pool({
  connectionString: DATABASE_URL,
  ssl: { rejectUnauthorized: false },
});

// „Éá„Éº„Çø„Éô„Éº„ÇπÂàùÊúüÂåñ
(async () => {
  await pool.query(`
    CREATE TABLE IF NOT EXISTS presences (
      id SERIAL PRIMARY KEY,
      user_id TEXT NOT NULL,
      user_name TEXT NOT NULL,
      start_time TIMESTAMP NOT NULL,
      end_time TIMESTAMP
    )
  `);
  console.log('DB „ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü');
})();

// „Éë„Éç„É´Êõ¥Êñ∞Èñ¢Êï∞
async function updatePresencePanel(client, channel) {
  const res = await pool.query(
    'SELECT * FROM presences WHERE end_time IS NULL ORDER BY start_time'
  );

  const embed = new EmbedBuilder()
    .setTitle('üìå ‰∫ãÂãôÊâÄ Âà©Áî®Áä∂Ê≥ÅÔºàÁèæÂú®Ôºâ')
    .setColor(0x2b6cb0);

  if (res.rows.length === 0) {
    embed.setDescription('ÁèæÂú®„ÄÅ‰∫ãÂãôÊâÄ„ÇíÂà©Áî®„Åó„Å¶„ÅÑ„Çã‰∫∫„ÅØ„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
  } else {
    embed.setDescription(
      res.rows
        .map(
          row =>
            `‚Ä¢ <@${row.user_id}> ‚Äî ÈñãÂßã: ${row.start_time.toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`
        )
        .join('\n')
    );
  }

  const row = new ActionRowBuilder().addComponents(
    new ButtonBuilder().setCustomId('start').setLabel('Âà©Áî®„Åó„Åæ„Åô').setStyle(ButtonStyle.Success),
    new ButtonBuilder().setCustomId('end').setLabel('ÈÄÄÂá∫„Åó„Åæ„Åô').setStyle(ButtonStyle.Danger)
  );

  // Êó¢Â≠ò„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊõ¥Êñ∞ or Êñ∞Ë¶è‰ΩúÊàê
  const messages = await channel.messages.fetch({ limit: 10 });
  const panelMsg = messages.find(m => m.author.id === client.user.id && m.embeds.length > 0);

  if (panelMsg) {
    await panelMsg.edit({ embeds: [embed], components: [row] });
  } else {
    await channel.send({ embeds: [embed], components: [row] });
  }
}

// Ëµ∑ÂãïÊôÇÂá¶ÁêÜ
client.once('ready', async () => {
  console.log('Discord „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åå„É≠„Ç∞„Ç§„É≥„Åó„Åæ„Åó„Åü');
  const channel = await client.channels.fetch(PRESENCE_CHANNEL_ID);
  if (channel) await updatePresencePanel(client, channel);
});

// „Éú„Çø„É≥Âá¶ÁêÜ
client.on('interactionCreate', async interaction => {
  if (!interaction.isButton()) return;

  const logChannel = await client.channels.fetch(LOG_CHANNEL_ID);

  if (interaction.customId === 'start') {
    await pool.query(
      'INSERT INTO presences (user_id, user_name, start_time) VALUES ($1, $2, NOW())',
      [interaction.user.id, interaction.user.username]
    );

    await interaction.reply({
      content: `‚úÖ ${interaction.user.username} „Åï„Çì„Åå‰∫ãÂãôÊâÄ„ÇíÂà©Áî®ÈñãÂßã„Åó„Åæ„Åó„ÅüÔºÅ`
    });

    if (logChannel) {
      await logChannel.send(`üì• ${interaction.user.username} „Åï„Çì„ÅåÂÖ•ÂÆ§„Åó„Åæ„Åó„Åü„ÄÇ(${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })})`);
    }

    await updatePresencePanel(client, interaction.channel);
  }

  if (interaction.customId === 'end') {
    await pool.query(
      'UPDATE presences SET end_time = NOW() WHERE user_id = $1 AND end_time IS NULL',
      [interaction.user.id]
    );

    await interaction.reply({
      content: `üëã ${interaction.user.username} „Åï„Çì„ÅåÈÄÄÂá∫„Åó„Åæ„Åó„ÅüÔºÅ`
    });

    if (logChannel) {
      await logChannel.send(`üì§ ${interaction.user.username} „Åï„Çì„ÅåÈÄÄÂá∫„Åó„Åæ„Åó„Åü„ÄÇ(${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })})`);
    }

    await updatePresencePanel(client, interaction.channel);
  }
});

// Render Áî® keep-alive
const app = express();
app.get('/', (req, res) => res.send('Bot is running.'));
app.listen(10000, () => console.log('HTTP „Çµ„Éº„Éê„Éº„Åå 10000 „Çí„É™„ÉÉ„Çπ„É≥„Åó„Å¶„ÅÑ„Åæ„Åô'));

client.login(TOKEN);










// // index.js
// require('dotenv').config();
// const express = require('express');
// const { Pool } = require('pg');
// const {
//   Client,
//   GatewayIntentBits,
//   ActionRowBuilder,
//   ButtonBuilder,
//   ButtonStyle,
//   EmbedBuilder,
//   ModalBuilder,
//   TextInputBuilder,
//   TextInputStyle
// } = require('discord.js');

// const DISCORD_TOKEN = process.env.DISCORD_TOKEN;
// const LOG_CHANNEL_ID = process.env.LOG_CHANNEL_ID; // Â±•Ê≠¥„É≠„Ç∞Áî®„ÉÅ„É£„É≥„Éç„É´

// if (!DISCORD_TOKEN) {
//   console.error('DISCORD_TOKEN is required');
//   process.exit(1);
// }

// // --- Express for Render health check (must bind PORT) ---
// const app = express();
// app.get('/', (req, res) => res.send('OK - office tracker'));
// const PORT = process.env.PORT || 10000;

// // --- Postgres (Neon) pool configuration ---
// const poolConfig = {
//   connectionString: process.env.DATABASE_URL || null,
//   max: process.env.PG_MAX ? Number(process.env.PG_MAX) : 5,
//   idleTimeoutMillis: 30000,
//   connectionTimeoutMillis: 20000
// };
// if (process.env.DATABASE_SSL === 'true') {
//   poolConfig.ssl = { rejectUnauthorized: false };
// }
// const pool = new Pool(poolConfig);

// // --- Discord client ---
// const client = new Client({ intents: [GatewayIntentBits.Guilds] });

// // --- DB initialization ---
// async function initDb() {
//   await pool.query(`
//     CREATE TABLE IF NOT EXISTS active_users (
//       user_id TEXT PRIMARY KEY,
//       username TEXT,
//       start BIGINT,
//       expected_end BIGINT,
//       note TEXT
//     );
//   `);
//   await pool.query(`
//     CREATE TABLE IF NOT EXISTS panel (
//       channel_id TEXT PRIMARY KEY,
//       message_id TEXT
//     );
//   `);
//   await pool.query(`
//     CREATE TABLE IF NOT EXISTS history (
//       id SERIAL PRIMARY KEY,
//       user_id TEXT,
//       username TEXT,
//       start BIGINT,
//       ended_at BIGINT,
//       note TEXT
//     );
//   `);
//   console.log('DB initialized');
// }

// // --- Helpers ---
// function fmtTs(ts) {
//   if (!ts) return 'Êú™Ë®≠ÂÆö';
//   const d = new Date(Number(ts) * 1000);
//   return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
// }
// function panelComponents() {
//   const row = new ActionRowBuilder().addComponents(
//     new ButtonBuilder().setCustomId('office_join').setLabel('Âà©Áî®„Åó„Åæ„Åô').setStyle(ButtonStyle.Success),
//     new ButtonBuilder().setCustomId('office_leave').setLabel('ÈÄÄÂá∫„Åó„Åæ„Åô').setStyle(ButtonStyle.Danger)
//   );
//   return [row];
// }
// async function buildPanelEmbed(channelId) {
//   const res = await pool.query('SELECT user_id, username, start, expected_end, note FROM active_users ORDER BY start');
//   const rows = res.rows || [];
//   let desc = '';
//   if (rows.length === 0) desc = 'ÁèæÂú®„ÄÅ‰∫ãÂãôÊâÄ„Å´„ÅÑ„Çã‰∫∫„ÅØ„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
//   else {
//     for (const r of rows) {
//       desc += `‚Ä¢ <@${r.user_id}> ‚Äî ÈñãÂßã: ${fmtTs(r.start)} / ÁµÇ‰∫Ü‰∫àÂÆö: ${r.expected_end ? fmtTs(r.expected_end) : 'Êú™Ë®≠ÂÆö'} ${r.note ? `Ôºè${r.note}` : ''}\n`;
//     }
//   }
//   return new EmbedBuilder()
//     .setTitle('üìå ‰∫ãÂãôÊâÄ Âà©Áî®Áä∂Ê≥ÅÔºàÁèæÂú®Ôºâ')
//     .setDescription(desc)
//     .setFooter({ text: '„ÄåÂà©Áî®„Åó„Åæ„Åô„Äç„ÇíÊäº„Åó„Å¶ÁôªÈå≤ÔºèÈÄÄÂá∫ÊôÇ„ÅØ„ÄåÈÄÄÂá∫„Åó„Åæ„Åô„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ' })
//     .setTimestamp();
// }
// async function updatePanel(channelId) {
//   try {
//     const rr = await pool.query('SELECT message_id FROM panel WHERE channel_id = $1', [channelId]);
//     if (!rr.rows.length) return;
//     const messageId = rr.rows[0].message_id;
//     const channel = await client.channels.fetch(channelId);
//     if (!channel) return;
//     const message = await channel.messages.fetch(messageId);
//     if (!message) return;
//     await message.edit({ embeds: [await buildPanelEmbed(channelId)], components: panelComponents() });
//   } catch (err) {
//     console.error('updatePanel error:', err);
//   }
// }

// // --- Send log to history channel ---
// async function sendLog(message) {
//   if (!LOG_CHANNEL_ID) return;
//   try {
//     const logChannel = await client.channels.fetch(LOG_CHANNEL_ID);
//     if (logChannel) await logChannel.send(message);
//   } catch (err) {
//     console.error('sendLog error:', err);
//   }
// }

// // --- Interaction handling (buttons, modal, commands) ---
// client.on('interactionCreate', async (interaction) => {
//   try {
//     if (interaction.isChatInputCommand()) {
//       const cmd = interaction.commandName;
//       if (cmd === 'setup-office') {
//         const embed = await buildPanelEmbed(interaction.channelId);
//         const sent = await interaction.channel.send({ embeds: [embed], components: panelComponents() });
//         await pool.query('INSERT INTO panel(channel_id, message_id) VALUES($1,$2) ON CONFLICT (channel_id) DO UPDATE SET message_id = EXCLUDED.message_id', [interaction.channelId, sent.id]);
//         await interaction.reply({ content: '‰∫ãÂãôÊâÄ„Éë„Éç„É´„ÇíË®≠ÁΩÆ„Åó„Åæ„Åó„Åü„ÄÇ', ephemeral: true });
//         return;
//       }
//       if (cmd === 'remove-office') {
//         await pool.query('DELETE FROM panel WHERE channel_id = $1', [interaction.channelId]);
//         await interaction.reply({ content: '„Åì„ÅÆ„ÉÅ„É£„É≥„Éç„É´„ÅÆ‰∫ãÂãôÊâÄ„Éë„Éç„É´ÊÉÖÂ†±„ÇíÂâäÈô§„Åó„Åæ„Åó„ÅüÔºà„É°„ÉÉ„Çª„Éº„Ç∏Ëá™‰Ωì„ÅØÊÆã„Çä„Åæ„ÅôÔºâ„ÄÇ', ephemeral: true });
//         return;
//       }
//     }

//     if (interaction.isButton()) {
//       if (interaction.customId === 'office_join') {
//         const modal = new ModalBuilder().setCustomId('office_join_modal').setTitle('‰∫ãÂãôÊâÄÂà©Áî®ÁôªÈå≤');
//         const endInput = new TextInputBuilder().setCustomId('endTime').setLabel('‰∫àÂÆöÁµÇ‰∫ÜÊôÇÂàªÔºà‰ªªÊÑè„ÄÅHH:MMÔºâ').setStyle(TextInputStyle.Short).setRequired(false);
//         const noteInput = new TextInputBuilder().setCustomId('note').setLabel('Áî®ÈÄî„ÇÑ„É°„É¢Ôºà‰ªªÊÑèÔºâ').setStyle(TextInputStyle.Short).setRequired(false);
//         modal.addComponents(new ActionRowBuilder().addComponents(endInput), new ActionRowBuilder().addComponents(noteInput));
//         await interaction.showModal(modal);
//         return;
//       }
//       if (interaction.customId === 'office_leave') {
//         const r = await pool.query('SELECT * FROM active_users WHERE user_id = $1', [interaction.user.id]);
//         if (!r.rows.length) {
//           await interaction.reply({ content: '„ÅÇ„Å™„Åü„ÅØÁèæÂú®ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ', ephemeral: true });
//           return;
//         }
//         const get = r.rows[0];
//         const now = Math.floor(Date.now() / 1000);
//         await pool.query('INSERT INTO history(user_id, username, start, ended_at, note) VALUES($1,$2,$3,$4,$5)',[get.user_id, get.username, get.start, now, get.note]);
//         await pool.query('DELETE FROM active_users WHERE user_id = $1', [interaction.user.id]);
//         await interaction.deferUpdate();

//         // Â±•Ê≠¥„ÉÅ„É£„É≥„Éç„É´„Å´ÈÄÅ‰ø°
//         await sendLog(`üü• ${interaction.user.username} „ÅåÈÄÄÂá∫„Åó„Åæ„Åó„ÅüÔºàÈñãÂßã: ${fmtTs(get.start)} ‚Üí ÈÄÄÂá∫: ${fmtTs(now)}Ôºâ„ÄÇ${get.note ? ` „É°„É¢: ${get.note}` : ''}`);

//         const panels = await pool.query('SELECT channel_id FROM panel');
//         for (const p of panels.rows) await updatePanel(p.channel_id);
//         return;
//       }
//     }

//     if (interaction.isModalSubmit && interaction.customId === 'office_join_modal') {
//       const exists = await pool.query('SELECT user_id FROM active_users WHERE user_id = $1', [interaction.user.id]);
//       if (exists.rows.length) {
//         await interaction.reply({ content: 'Êó¢„Å´‰∫ãÂãôÊâÄÂà©Áî®‰∏≠„Å®„Åó„Å¶ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÈÄÄÂá∫„Åô„ÇãÂ†¥Âêà„ÅØ„ÄåÈÄÄÂá∫„Åó„Åæ„Åô„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', ephemeral: true });
//         return;
//       }
//       const endText = interaction.fields.getTextInputValue('endTime') || '';
//       const note = interaction.fields.getTextInputValue('note') || '';
//       let expectedEnd = null;
//       if (endText.trim()) {
//         const m = endText.trim().match(/^(\d{1,2}):(\d{2})$/);
//         if (m) {
//           const hh = parseInt(m[1], 10), mm = parseInt(m[2], 10);
//           const now = new Date();
//           const endDate = new Date(now);
//           endDate.setHours(hh, mm, 0, 0);
//           if (endDate.getTime() <= now.getTime()) endDate.setDate(endDate.getDate() + 1);
//           expectedEnd = Math.floor(endDate.getTime() / 1000);
//         } else {
//           await interaction.reply({ content: '‰∫àÂÆöÁµÇ‰∫ÜÊôÇÂàª„ÅØ HH:MM ÂΩ¢Âºè„ÅßÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÁÑ°Âäπ„Å™ÂΩ¢Âºè„Å™„ÅÆ„Åß‰∫àÂÆöÁµÇ‰∫Ü„ÅØÊú™Ë®≠ÂÆö„ÅßÁôªÈå≤„Åó„Åæ„Åô„ÄÇ', ephemeral: true });
//         }
//       }
//       const nowTs = Math.floor(Date.now() / 1000);
//       const username = `${interaction.user.username}#${interaction.user.discriminator}`;
//       await pool.query('INSERT INTO active_users(user_id, username, start, expected_end, note) VALUES($1,$2,$3,$4,$5)', [interaction.user.id, username, nowTs, expectedEnd, note]);
//       await interaction.deferUpdate();

//       // Â±•Ê≠¥„ÉÅ„É£„É≥„Éç„É´„Å´ÈÄÅ‰ø°
//       await sendLog(`üü© ${interaction.user.username} „ÅåÂà©Áî®„ÇíÈñãÂßã„Åó„Åæ„Åó„ÅüÔºàÈñãÂßã: ${fmtTs(nowTs)}${expectedEnd ? ` ‚Üí ÁµÇ‰∫Ü‰∫àÂÆö: ${fmtTs(expectedEnd)}` : ''}Ôºâ„ÄÇ${note ? ` „É°„É¢: ${note}` : ''}`);

//       const panels = await pool.query('SELECT channel_id FROM panel');
//       for (const p of panels.rows) await updatePanel(p.channel_id);
//     }
//   } catch (err) {
//     console.error('interaction error:', err);
//     try { if (interaction && !interaction.replied) await interaction.reply({ content: 'ÂÜÖÈÉ®„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', ephemeral: true }); } catch {}
//   }
// });

// // --- auto-expire scheduled check every minute ---
// setInterval(async () => {
//   try {
//     const now = Math.floor(Date.now() / 1000);
//     const rr = await pool.query('SELECT user_id, username, start, expected_end, note FROM active_users WHERE expected_end IS NOT NULL AND expected_end <= $1', [now]);
//     for (const r of rr.rows) {
//       await pool.query('INSERT INTO history(user_id, username, start, ended_at, note) VALUES($1,$2,$3,$4,$5)',[r.user_id, r.username, r.start, r.expected_end, r.note]);
//       await pool.query('DELETE FROM active_users WHERE user_id = $1', [r.user_id]);

//       // Â±•Ê≠¥„ÉÅ„É£„É≥„Éç„É´„Å´ÈÄÅ‰ø°
//       await sendLog(`‚è∞ ${r.username} „ÅÆÂà©Áî®ÊôÇÈñì„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„ÅüÔºàÈñãÂßã: ${fmtTs(r.start)} ‚Üí Ëá™ÂãïÁµÇ‰∫Ü: ${fmtTs(r.expected_end)}Ôºâ„ÄÇ${r.note ? ` „É°„É¢: ${r.note}` : ''}`);
//     }
//     const panels = await pool.query('SELECT channel_id FROM panel');
//     for (const p of panels.rows) await updatePanel(p.channel_id);
//   } catch (err) {
//     console.error('auto-expire error:', err);
//   }
// }, 60 * 1000);

// // --- start up ---
// (async () => {
//   try {
//     if (!process.env.DATABASE_URL) console.warn('DATABASE_URL not set ‚Äî DB operations will fail until you set it.');
//     await initDb();
//     app.listen(PORT, '0.0.0.0', () => console.log(`HTTP server listening on ${PORT}`));
//     await client.login(DISCORD_TOKEN);
//     console.log('Discord client logged in');
//   } catch (err) {
//     console.error('startup error', err);
//     process.exit(1);
//   }
// })();

